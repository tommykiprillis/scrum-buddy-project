<%- include ("partials/header.ejs"); -%>

    <div class="mt-5 px-sm-5 container-fluid">
        <span class="badge p-2 me-auto text-bg-dark rounded-pill mb-2"><%=sprintStatus%></span>
        <div class="d-flex gap-3 align-items-center">
            <h1 class="mb-2"><%= sprintDetails.name %></h1>    
            <button class="btn btn-outline-dark rounded-circle p-1 lh-1 d-flex align-items-center justify-content-center" type="button" data-bs-toggle="modal" data-bs-target="#sprintDetails" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots" viewBox="0 0 16 16">
                    <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"/>
                </svg>
            </button> 
        </div>

        <div class="d-flex justify-content-start mb-4 fs-5 gap-3 align-items-center">
            <div class="text-secondary py-1"><%= new Date(sprintDetails.start_date).toLocaleDateString('en-AU', { day: '2-digit', month: '2-digit', year: 'numeric' }); %> - 
                <%= new Date(sprintDetails.end_date).toLocaleDateString('en-AU', { day: '2-digit', month: '2-digit', year: 'numeric' }); %>
            </div>
            <!-- Start Sprint button-->
            <% if (locals.displayStartButton) { %>
                <form action="/startSprint" method="POST">
                    <button class="btn btn-outline-primary d-inline-flex align-items-center rounded-pill py-1" type="submit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-rocket-takeoff" viewBox="0 0 16 16">
                            <path d="M9.752 6.193c.599.6 1.73.437 2.528-.362s.96-1.932.362-2.531c-.599-.6-1.73-.438-2.528.361-.798.8-.96 1.933-.362 2.532"/>
                            <path d="M15.811 3.312c-.363 1.534-1.334 3.626-3.64 6.218l-.24 2.408a2.56 2.56 0 0 1-.732 1.526L8.817 15.85a.51.51 0 0 1-.867-.434l.27-1.899c.04-.28-.013-.593-.131-.956a9 9 0 0 0-.249-.657l-.082-.202c-.815-.197-1.578-.662-2.191-1.277-.614-.615-1.079-1.379-1.275-2.195l-.203-.083a10 10 0 0 0-.655-.248c-.363-.119-.675-.172-.955-.132l-1.896.27A.51.51 0 0 1 .15 7.17l2.382-2.386c.41-.41.947-.67 1.524-.734h.006l2.4-.238C9.005 1.55 11.087.582 12.623.208c.89-.217 1.59-.232 2.08-.188.244.023.435.06.57.093q.1.026.16.045c.184.06.279.13.351.295l.029.073a3.5 3.5 0 0 1 .157.721c.055.485.051 1.178-.159 2.065m-4.828 7.475.04-.04-.107 1.081a1.54 1.54 0 0 1-.44.913l-1.298 1.3.054-.38c.072-.506-.034-.993-.172-1.418a9 9 0 0 0-.164-.45c.738-.065 1.462-.38 2.087-1.006M5.205 5c-.625.626-.94 1.351-1.004 2.09a9 9 0 0 0-.45-.164c-.424-.138-.91-.244-1.416-.172l-.38.054 1.3-1.3c.245-.246.566-.401.91-.44l1.08-.107zm9.406-3.961c-.38-.034-.967-.027-1.746.163-1.558.38-3.917 1.496-6.937 4.521-.62.62-.799 1.34-.687 2.051.107.676.483 1.362 1.048 1.928.564.565 1.25.941 1.924 1.049.71.112 1.429-.067 2.048-.688 3.079-3.083 4.192-5.444 4.556-6.987.183-.771.18-1.345.138-1.713a3 3 0 0 0-.045-.283 3 3 0 0 0-.3-.041Z"/>
                            <path d="M7.009 12.139a7.6 7.6 0 0 1-1.804-1.352A7.6 7.6 0 0 1 3.794 8.86c-1.102.992-1.965 5.054-1.839 5.18.125.126 3.936-.896 5.054-1.902Z"/>
                            </svg>&nbsp;Start Sprint
                        </button>
                </form>

            <% } %>
    
            <% if (locals.displayCompleteButton) { %>
                <!-- Complete Sprint button-->
                <form action="/completeSprint" method="POST">
                    <button class="btn btn-outline-success d-inline-flex align-items-center rounded-pill py-1" type="submit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16">
                            <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425z"/>
                        </svg>&nbsp;Complete Sprint
                    </button>
                </form>

            <% } %>
        </div>
        <div class="d-flex justify-content-lg-end">
            <a href="/viewSprint" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-kanban" viewBox="0 0 16 16">
                    <path d="M13.5 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zm-11-1a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
                    <path d="M6.5 3a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1zm-4 0a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1zm8 0a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1z"/>
                </svg>
            View Sprint Board
            </a>
        </div>

        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="canvas-container" style="width: 100%; max-width: 100%; overflow-x: auto;">
                        <canvas id="burndownChart" style="min-width: 300px; height: 250px; width: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>
       
    </div>

      <!--Modal for viewing the details of a sprint-->
  <div class="modal fade" id="sprintDetails" tabindex="-1">
	<div class="modal-dialog" style="max-width: 50rem;">
	  <div class="modal-content">
		<div class="modal-body">
		  <form action="/editSprint" method="POST">
			<!--Stores the id of the sprint as a hidden value-->
			<input type="hidden" name="id" value="<%=sprintDetails.id%>">

			<!--Sprint Name at top (prefill + save)-->
			<label for="titleEditSprint" class="form-label">Sprint Name</label>
			<input class="form-control form-control" id="titleEditSprint" type="text" value="<%=sprintDetails.name%>" name="name" autocomplete="off">
			
			<!--Start and end date for sprint-->
			<div class="row mt-4">
				<!-- Start Date for the sprint -->
				<div class="col">
					<label for="startDateEdit" class="form-label">Start Date</label>
					<input class="form-control" id="startDateEdit" type="date" name="startDate" autocomplete="off" min="<%= date %>" required aria-describedby="sdHelpBlock"
						value="<%= new Date(new Date(sprintDetails.start_date).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0] %>"
                        <% if (sprintStatus !== "Not Started") { %>
                            readonly data-bs-toggle="tooltip" data-bs-title="Cannot be modified once sprint has started"
                           <% } %>>
                    <div id="sdHelpBlock" class="form-text">
                        Sprint must be at least 1-3 weeks long
                    </div>
				</div>
			
				<!-- End Date for the sprint -->
				<div class="col">
					<label for="endDateEdit" class="form-label">End Date</label>
					<input class="form-control" id="endDateEdit" type="date" name="endDate" autocomplete="off" min="<%= new Date(new Date(sprintDetails.start_date).getTime() + 7 * 24 * 60 * 60 * 1000 - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0] %>" max="<%= new Date(new Date(sprintDetails.start_date).getTime() + 21 * 24 * 60 * 60 * 1000 - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0] %>" required
						value="<%= new Date(new Date(sprintDetails.end_date).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0] %>"
                        <% if (sprintStatus !== "Not Started") { %>
                            readonly data-bs-toggle="tooltip" data-bs-title="Cannot be modified once sprint has started"
                           <% } %>>
				</div>
			</div>
			
    
			
            <!-- Scrum Master and Product Owner for sprint-->
            <div class="row mt-4">
                <!--Scrum Master-->
                    <div class="col">
                        <label for="scrumMasterEdit" class="form-label">Scrum Master</label>
                        <select class="form-control form-control" id="scrumMasterEdit" name="scrumMaster" required
                        <% if (sprintStatus !== "Not Started") { %>
                            readonly data-bs-toggle="tooltip" data-bs-title="Cannot be modified once sprint has started"
                        <% } %>>
                        <% if (sprintDetails.scrum_master !== null) { %>
                            <option value="<%=sprintDetails.scrum_master%>" selected><%=sprintDetails.scrum_master%></option>
                            <% } else {%>
                            <option value="" selected>None</option>
                            <% } %>
                            <% sprintMembers.forEach(member => { %>
                                <% if (member.name !== sprintDetails.scrum_master) { %>
                                    <option value="<%= member.name %>"><%= member.name %></option>
                                <% } %>
                            <% }) %>
                        </select>
                    </div>
                <!--Product Owner-->
                <div class="col">
                    <label for="productOwnerEdit" class="form-label">Product Owner</label>
                    <select class="form-control form-control" id="productOwnerEdit" name="productOwner" required
                    <% if (sprintStatus !== "Not Started") { %>
                        readonly data-bs-toggle="tooltip" data-bs-title="Cannot be modified once sprint has started"
                    <% } %>>
                    <% if (sprintDetails.product_owner !== null) { %>
                        <option value="<%=sprintDetails.product_owner%>" selected><%=sprintDetails.product_owner%></option>
                        <% } else {%>
                        <option value="" selected>None</option>
                        <% } %>
                        <% sprintMembers.forEach(member => { %>
                            <% if (member.name !== sprintDetails.product_owner) { %>
                                <option value="<%= member.name %>"><%= member.name %></option>
                            <% } %>
                        <% }) %>
                    </select>
                </div>
            </div>

            <label for="userOptions" class="form-label mt-4">Sprint Members</label>
            <ul id="userOptions" class="list-group">
              <% sprintMembers.forEach(member => { %>
                <li class="list-group-item">
                    <%= member.name %>
                </li>
              <% }) %>
			</ul>	
            
			<!--Description (prefill + save)-->
			<label for="descriptionEdit" class="form-label mt-3">Description</label>
			<textarea class="form-control" id="descriptionEdit" rows="3" name="description" autocomplete="off"><% if (sprintDetails.description !== null) { %><%=sprintDetails.description%><% } %></textarea>

			<!--Saving Changes-->
			<button type="submit" class="btn btn-primary mt-3">Save Changes</button>
		  </form>
			<!--Delete Sprint-->
			<input type="hidden" name="sprintId" value="<%=sprintDetails.id%>">
			<button type="button" class="btn btn-outline-danger mt-3" data-bs-target="#deleteConfirmationSprint" data-bs-toggle="modal"">Delete Sprint</button>
		</div>
	  </div>
	</div>
  </div>
  
  <div class="modal fade" id="deleteConfirmationSprint" tabindex="-1">
	<div class="modal-dialog modal-dialog-centered" style="max-width: 50rem;">
	<div class="modal-content">
		<div class="modal-body">
			<p>Are you sure you want to delete this sprint? This action cannot be undone.</p>
		</div>
		<div class="modal-footer">
			<form action="/deleteSprint" method="POST">
				<!--Delete Sprint-->
				<input type="hidden" name="sprintId" value="<%=sprintDetails.id%>">
				<button type="submit" class="btn btn-outline-danger">Delete Sprint</button>
			</form>
			<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
		</div>
	</div>
	</div>
	</div>

    <script>
        // get the data passed from the server
        const actualData = JSON.parse('<%- actualBurndownData %>');
        const idealData = JSON.parse('<%- idealBurndownData %>');

        // generate labels based on the length of the data
        const labels = idealData.map((_, index) => `Day ${index + 1}`);

        // get the canvas context
        const ctx = document.getElementById('burndownChart').getContext('2d');

        // create a new line chart
        const burndownChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Actual Burndown',
                        data: actualData.map(data => data.storyPoints),
                        borderColor: 'rgba(255, 52, 48, 0.8)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        fill: false,
                        tension: 0.1
                    },
                    {
                        label: 'Ideal Burndown',
                        data: idealData.map(data => data.storyPoints),
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        fill: false,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Story Points'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Days'
                        }
                    }
                }
            }
        });
    </script>
  <%- include ("partials/footer.ejs"); -%>