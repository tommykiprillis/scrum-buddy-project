<%- include ("partials/header.ejs"); -%>

    <div class="mt-5 px-sm-5 container-fluid">
        <span class="badge p-2 me-auto text-bg-dark rounded-pill mb-2"><%=sprintStatus%></span>
        <div class="d-flex gap-3 align-items-center">
            <h1 class="mb-2"><%= sprintDetails.name %></h1>    
            <button class="btn bg-body-secondary rounded-circle p-1 lh-1 d-flex align-items-center justify-content-center" type="button" data-bs-toggle="modal" data-bs-target="#sprintDetails" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots" viewBox="0 0 16 16">
                    <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"/>
                </svg>
            </button> 
        </div>

        <p class="fs-5 text-secondary mb-4">
            <%= new Date(sprintDetails.start_date).toLocaleDateString('en-AU', { day: '2-digit', month: '2-digit', year: 'numeric' }); %> - 
            <%= new Date(sprintDetails.end_date).toLocaleDateString('en-AU', { day: '2-digit', month: '2-digit', year: 'numeric' }); %>
        </p>
        <div class="d-flex justify-content-lg-end">
            <a href="/viewSprint" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-kanban" viewBox="0 0 16 16">
                    <path d="M13.5 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zm-11-1a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
                    <path d="M6.5 3a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1zm-4 0a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1zm8 0a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1z"/>
                </svg>
            View Sprint Board
            </a>
        </div>

        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="canvas-container" style="width: 100%; max-width: 100%; overflow-x: auto;">
                        <canvas id="burndownChart" style="min-width: 300px; height: 250px; width: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>
       
    </div>

      <!--Modal for viewing the details of a sprint-->
  <div class="modal fade" id="sprintDetails" tabindex="-1">
	<div class="modal-dialog" style="max-width: 50rem;">
	  <div class="modal-content">
		<div class="modal-body">
		  <form action="/editSprint" method="POST">
			<!--Stores the id of the sprint as a hidden value-->
			<input type="hidden" name="id" value="<%=sprintDetails.id%>">

			<!--Sprint Name at top (prefill + save)-->
			<label for="titleEditSprint" class="form-label">Sprint Name</label>
			<input class="form-control form-control" id="titleEditSprint" type="text" value="<%=sprintDetails.name%>" name="name" autocomplete="off">
			
			<!--Start and end date for sprint-->
			<div class="row mt-4">
				<!-- Start Date for the sprint -->
				<div class="col">
					<label for="startDateEdit" class="form-label">Start Date</label>
					<input class="form-control" id="startDateEdit" type="date" name="startDate" autocomplete="off" 
						value="<%= new Date(new Date(sprintDetails.start_date).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0] %>">
				</div>
			
				<!-- End Date for the sprint -->
				<div class="col">
					<label for="endDateEdit" class="form-label">End Date</label>
					<input class="form-control" id="endDateEdit" type="date" name="endDate" autocomplete="off" 
						value="<%= new Date(new Date(sprintDetails.end_date).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0] %>">
				</div>
			</div>
			
			
			<!-- Scrum Master and Product Owner for sprint-->
			<div class="row mt-4">
				<!--Scrum Master-->
					<div class="col">
					<label for="scrumMasterEdit" class="form-label">Scrum Master</label>
					<input class="form-control form-control" id="scrumMasterEdit" type="text" value="<%=sprintDetails.scrum_master%>" name="scrumMaster" autocomplete="off">
					</div>
	
				<!--Product Owner-->
					<div class="col">
					<label for="productOwnerEdit" class="form-label">Product Owner</label>
					<input class="form-control form-control" id="productOwnerEdit" type="text" value="<%=sprintDetails.product_owner%>" name="productOwner" autocomplete="off">					</div>
			</div>

			<!--Description (prefill + save)-->
			<label for="descriptionEdit" class="form-label mt-3">Description</label>
			<textarea class="form-control" id="descriptionEdit" rows="3" name="description" autocomplete="off"><% if (sprintDetails.description !== null) { %><%=sprintDetails.description%><% } %></textarea>

			<!--Saving Changes-->
			<button type="submit" class="btn btn-primary mt-3">Save Changes</button>
		  </form>
			<!--Delete Sprint-->
			<input type="hidden" name="sprintId" value="<%=sprintDetails.id%>">
			<button type="button" class="btn btn-outline-danger mt-3" data-bs-target="#deleteConfirmationSprint" data-bs-toggle="modal"">Delete Sprint</button>
		</div>
	  </div>
	</div>
  </div>
  
  <div class="modal fade" id="deleteConfirmationSprint" tabindex="-1">
	<div class="modal-dialog modal-dialog-centered" style="max-width: 50rem;">
	<div class="modal-content">
		<div class="modal-body">
			<p>Are you sure you want to delete this sprint? This action cannot be undone.</p>
		</div>
		<div class="modal-footer">
			<form action="/deleteSprint" method="POST">
				<!--Delete Sprint-->
				<input type="hidden" name="sprintId" value="<%=sprintDetails.id%>">
				<button type="submit" class="btn btn-outline-danger">Delete Sprint</button>
			</form>
			<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
		</div>
	</div>
	</div>
	</div>

    <script>
        // get the data passed from the server
        const actualData = JSON.parse('<%- actualBurndownData %>');
        const idealData = JSON.parse('<%- idealBurndownData %>');

        // generate labels based on the length of the data
        const labels = idealData.map((_, index) => `Day ${index + 1}`);

        // get the canvas context
        const ctx = document.getElementById('burndownChart').getContext('2d');

        // create a new line chart
        const burndownChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Actual Burndown',
                        data: actualData.map(data => data.storyPoints),
                        borderColor: 'rgba(255, 52, 48, 0.8)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        fill: false,
                        tension: 0.1
                    },
                    {
                        label: 'Ideal Burndown',
                        data: idealData.map(data => data.storyPoints),
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        fill: false,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Story Points'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Days'
                        }
                    }
                }
            }
        });
    </script>
  <%- include ("partials/footer.ejs"); -%>